<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanrico Mercantile - Staff Dashboard</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/modal.css">
    <link rel="stylesheet" href="css/tooltip.css">
    <link rel="stylesheet" href="css/staff-dashboard.css">
    <script src="js/auth.js"></script>
    <script src="js/toast.js"></script>
    <style>
        /* Collection badges for debugging/clarity */
        .collection-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
            margin-left: 5px;
            text-transform: uppercase;
        }
        
        .collection-badge.pending {
            background: rgba(255, 193, 7, 0.2);
            color: #856404;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        
        .collection-badge.accepted {
            background: rgba(40, 167, 69, 0.2);
            color: #155724;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }
        
        .collection-badge.delivered {
            background: rgba(111, 66, 193, 0.2);
            color: #4c2c92;
            border: 1px solid rgba(111, 66, 193, 0.3);
        }

        /* Loading animations */
        .loadingBob {
            animation: loadingBob 1.5s ease-in-out infinite;
        }

        @keyframes loadingBob {
            0%, 20%, 80%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-3px);
            }
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            flex-direction: column;
            gap: 1rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #e63946;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #666;
            font-size: 0.9rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="staff-header">
        <div class="container header-container">
            <div class="logo-container">
                <img src="images/sanrico_logo_1.png" alt="Sanrico Mercantile Logo" class="logo-img">
                <div class="logo">
                    Sanrico <span>Mercantile</span> - Staff Dashboard
                </div>
            </div>
            <div class="header-controls">
                <div class="notification-container">
                    <button class="notification-btn" id="notificationBtn">
                        <span class="notification-icon">🔔</span>
                        <span class="notification-badge" id="notificationBadge">0</span>
                    </button>
                    <div class="notification-dropdown" id="notificationDropdown">
                        <div class="notification-header">
                            <h3>Notifications</h3>
                            <button class="clear-all-btn" id="clearAllBtn">Clear All</button>
                        </div>
                        <div class="notification-list" id="notificationList">
                            <!-- Notifications will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="staff-info">
                    <span id="staffName">Staff Member</span>
                    <button class="logout-btn" id="logoutBtn">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Dashboard Layout -->
    <div class="dashboard-layout">
        <!-- Left Sidebar Navigation -->
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <h3 class="nav-section-title">Management</h3>
                    <button class="nav-item active" data-section="dashboard">
                        <span class="nav-icon">📊</span>
                        <span class="nav-text">Dashboard</span>
                    </button>
                    <button class="nav-item" data-section="products">
                        <span class="nav-icon">📦</span>
                        <span class="nav-text">Product Management</span>
                    </button>
                    <button class="nav-item" data-section="orders">
                        <span class="nav-icon">📋</span>
                        <span class="nav-text">Order Management</span>
                        <span class="nav-badge" id="ordersBadge">0</span>
                    </button>
                    <button class="nav-item" data-section="walkin">
                        <span class="nav-icon">🚶</span>
                        <span class="nav-text">Walk-in Orders</span>
                    </button>
                </div>
                <div class="nav-section">
                    <h3 class="nav-section-title">Point of Sale</h3>
                    <button class="nav-item" data-section="cashier">
                        <span class="nav-icon">💰</span>
                        <span class="nav-text">Cashier POS</span>
                    </button>
                </div>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Dashboard Overview Section -->
            <section class="content-section active" id="dashboard-section">
                <div class="section-header">
                    <h1>Dashboard Overview</h1>
                    <div class="date-range-selector">
                        <input type="date" id="dashboardStartDate" class="form-control">
                        <span>to</span>
                        <input type="date" id="dashboardEndDate" class="form-control">
                        <button class="action-btn primary" id="refreshDashboard">Refresh</button>
                    </div>
                </div>

                <!-- Dashboard Stats -->
                <div class="dashboard-stats">
                    <div class="stat-card clickable" id="totalProductsCard" data-section="products">
                        <div class="stat-icon">📦</div>
                        <div class="stat-info">
                            <div class="stat-number" id="totalProducts">0</div>
                            <div class="stat-label">Total Products</div>
                        </div>
                    </div>
                    <div class="stat-card clickable" id="pendingOrdersCard" data-section="orders">
                        <div class="stat-icon">📋</div>
                        <div class="stat-info">
                            <div class="stat-number" id="pendingOrders">0</div>
                            <div class="stat-label">Pending Orders</div>
                        </div>
                    </div>
                    <div class="stat-card clickable" id="deliveredOrdersCard" data-section="orders">
                        <div class="stat-icon">✅</div>
                        <div class="stat-info">
                            <div class="stat-number" id="completedOrders">0</div>
                            <div class="stat-label">Delivered Orders</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">🚚</div>
                        <div class="stat-info">
                            <div class="stat-number" id="deliveredProducts">0</div>
                            <div class="stat-label">Delivered Products</div>
                        </div>
                    </div>
                    <div class="stat-card clickable" id="walkInOrdersCard" data-section="walkin">
                        <div class="stat-icon">🚶</div>
                        <div class="stat-info">
                            <div class="stat-number" id="walkInOrders">0</div>
                            <div class="stat-label">Walk-in Orders</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">💰</div>
                        <div class="stat-info">
                            <div class="stat-number" id="totalRevenue">₱0.00</div>
                            <div class="stat-label">Total Revenue</div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="recent-activity">
                    <h2>Recent Activity</h2>
                    <div class="activity-list" id="activityList">
                        <!-- Recent activities will be populated here -->
                    </div>
                </div>
            </section>

            <!-- Product Management Section -->
            <section class="content-section" id="products-section">
                <div class="section-header">
                    <h1>Product Management</h1>
                    <div class="section-controls">
                        <select id="categoryFilter" class="form-control">
                            <option value="all">All Categories</option>
                            <option value="power-tools">Power Tools</option>
                            <option value="hand-tools">Hand Tools</option>
                            <option value="plumbing">Plumbing</option>
                            <option value="electrical">Electrical</option>
                            <option value="building-materials">Building Materials</option>
                        </select>
                        <input type="text" id="productSearch" class="form-control" placeholder="Search products...">
                    </div>
                </div>
                <div class="products-table-container">
                    <table class="products-table" id="productsTable">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Product Name</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <!-- Products will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="productsPagination"></div>
            </section>

            <!-- Order Management Section -->
            <section class="content-section" id="orders-section">
                <div class="section-header">
                    <h1>Order Management</h1>
                    <div class="section-controls">
                        <div class="date-range-filter">
                            <label>From:</label>
                            <input type="date" id="orderStartDate" class="form-control">
                            <label>To:</label>
                            <input type="date" id="orderEndDate" class="form-control">
                        </div>
                        <select id="orderStatusFilter" class="form-control">
                            <option value="all">All Orders</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="delivered">Delivered</option>
                        </select>
                        <select id="paymentMethodFilter" class="form-control">
                            <option value="all">All Payment Methods</option>
                            <option value="cash">Cash</option>
                            <option value="gcash">GCash</option>
                            <option value="bank">Bank Transfer</option>
                        </select>
                        <button class="action-btn primary" id="refreshOrdersBtn">🔄 Refresh</button>
                    </div>
                </div>
                <div class="orders-table-container">
                    <table class="orders-table" id="ordersTable">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Payment Method</th>
                                <th>Shipping</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- Orders will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="ordersPagination"></div>
            </section>

            <!-- Walk-in Orders Section -->
            <section class="content-section" id="walkin-section">
                <div class="section-header">
                    <h1>Walk-in Orders</h1>
                    <div class="section-controls">
                        <button class="action-btn secondary" id="clearWalkInListBtn">🗑️ Clear List</button>
                    </div>
                </div>
                <div class="walkin-orders-container">
                    <div class="walkin-stats">
                        <div class="walkin-stat">
                            <span class="stat-label">Today's Walk-ins:</span>
                            <span class="stat-value" id="todayWalkIns">0</span>
                        </div>
                        <div class="walkin-stat">
                            <span class="stat-label">This Week:</span>
                            <span class="stat-value" id="weekWalkIns">0</span>
                        </div>
                        <div class="walkin-stat">
                            <span class="stat-label">This Month:</span>
                            <span class="stat-value" id="monthWalkIns">0</span>
                        </div>
                    </div>
                    <div class="walkin-orders-table-container">
                        <table class="orders-table" id="walkInOrdersTable">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Payment Method</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="walkInOrdersTableBody">
                                <!-- Walk-in orders will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Cashier POS Section -->
            <section class="content-section" id="cashier-section">
                <div class="section-header">
                    <h1>Cashier Point of Sale</h1>
                    <div class="pos-controls">
                        <button class="action-btn secondary" id="clearCartBtn">Clear Cart</button>
                        <button class="action-btn primary" id="newTransactionBtn">New Transaction</button>
                    </div>
                </div>

                <div class="pos-layout">
                    <!-- Product Selection Area -->
                    <div class="pos-products">
                        <div class="pos-search">
                            <input type="text" id="posProductSearch" class="form-control" placeholder="Search product...">
                            <button class="action-btn primary" id="scanProductBtn">Search</button>
                        </div>
                        <div class="pos-categories">
                            <button class="category-btn active" data-category="all">All</button>
                            <button class="category-btn" data-category="power-tools">Power Tools</button>
                            <button class="category-btn" data-category="hand-tools">Hand Tools</button>
                            <button class="category-btn" data-category="building-materials">Building Materials</button>
                            <button class="category-btn" data-category="plumbing">Plumbing</button>
                            <button class="category-btn" data-category="electrical">Electrical</button>
                        </div>
                        <div class="pos-products-grid" id="posProductsGrid">
                            <!-- POS Products will be loaded here -->
                        </div>
                    </div>

                    <!-- Cart and Checkout Area -->
                    <div class="pos-cart">
                        <div class="cart-header">
                            <h3>Current Order</h3>
                            <span class="cart-count" id="cartCount">0 items</span>
                        </div>
                        <div class="cart-items" id="cartItems">
                            <div class="empty-cart">
                                <p>No items in cart</p>
                            </div>
                        </div>
                        <div class="cart-summary">
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <span id="subtotal">₱0.00</span>
                            </div>
                            <div class="summary-row total">
                                <span>Total:</span>
                                <span id="total">₱0.00</span>
                            </div>
                        </div>
                        <div class="checkout-section">
                            <div class="customer-info">
                                <input type="text" id="customerName" class="form-control" placeholder="Customer Name (Optional)">
                                <input type="tel" id="customerPhone" class="form-control" placeholder="Phone Number (Optional)">
                            </div>
                            <button class="action-btn primary checkout-btn" id="checkoutBtn" disabled>
                                Proceed to Payment
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Product Edit Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <button class="modal-close" id="productModalClose">×</button>
            <h2 class="modal-title">Edit Product</h2>
            
            <div class="product-edit-form">
                <div class="form-group">
                    <label>Product Name:</label>
                    <input type="text" id="productName" readonly class="form-control readonly-field">
                </div>
                
                <div class="form-group">
                    <label>Product Image:</label>
                    <div class="image-upload-section">
                        <div class="drop-zone" id="dropZone">
                            <div class="drop-zone-content">
                                <div class="upload-icon">📁</div>
                                <p>Drag and drop an image here or click to browse</p>
                                <input type="file" id="fileInput" accept="image/*" hidden>
                            </div>
                            <div class="image-preview hidden" id="imagePreview">
                                <img id="previewImg" src="images/sanrico_logo_1.png" alt="Preview">
                            </div>
                        </div>
                        <button type="button" class="action-btn cancel hidden" id="removeImageBtn">Remove Image</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Stock Quantity:</label>
                    <input type="number" id="productStock" class="form-control" min="0">
                </div>
            </div>

            <div class="modal-actions">
                <button class="action-btn cancel" id="cancelEdit">Cancel</button>
                <button class="action-btn primary" id="saveProduct">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal" id="orderModal">
        <div class="modal-content order-modal-content">
            <button class="modal-close" id="orderModalClose">×</button>
            
            <!-- Header -->
            <div class="modal-header">
                <h2 class="modal-title">Order Details</h2>
            </div>
            
            <div class="order-details-form">
                <!-- Order Info Card -->
                <div class="order-card-section">
                    <div class="order-header-card">
                        <div class="order-id-section">
                            <h3 id="staffModalOrderId">#12345</h3>
                            <button class="copy-btn" onclick="copyStaffOrderId()">Copy</button>
                        </div>
                        <div class="order-date-section">
                            <span id="staffModalOrderDate">Jun 25, 2025 5:53 PM</span>
                        </div>
                    </div>
                </div>

                <!-- Customer Information Card -->
                <div class="order-card-section">
                    <h3 class="section-title">Customer Information</h3>
                    <div class="info-grid" id="staffCustomerInfo">
                        <!-- Customer info will be populated here -->
                    </div>
                </div>
                
                <!-- Order Summary Card -->
                <div class="order-card-section">
                    <h3 class="section-title">Order Summary</h3>
                    <div class="items-list-modern" id="staffModalOrderItems">
                        <!-- Items will be populated here -->
                    </div>
                    
                    <div class="order-totals">
                        <div class="total-row">
                            <span>Subtotal</span>
                            <span id="staffModalSubtotal">₱0.00</span>
                        </div>
                        <div class="total-row final-total">
                            <span>Total</span>
                            <span id="staffModalTotal">₱0.00</span>
                        </div>
                    </div>
                </div>
                
                <!-- Staff Information Card -->
                <div class="order-card-section">
                    <h3 class="section-title">Staff Information</h3>
                    <div class="info-grid" id="staffOrderTechnicalInfo">
                        <!-- Technical info will be populated here -->
                    </div>
                </div>
                
                <!-- Payment Information Card -->
                <div class="order-card-section">
                    <h3 class="section-title">Payment Information</h3>
                    <div class="payment-info" id="staffPaymentInfo">
                        <!-- Payment info will be populated here -->
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="action-btn cancel" id="closeOrderModal">Close</button>
                <select id="orderStatusSelect" class="form-control" style="margin: 0 1rem;">
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="delivered">Delivered</option>
                </select>
                <button class="action-btn primary" id="updateOrderStatus">Update Status</button>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <button class="modal-close" id="paymentModalClose">×</button>
            <h2 class="modal-title">Payment Processing</h2>
            
            <div class="payment-summary">
                <div class="payment-total">
                    Total Amount: <span id="paymentTotal">₱0.00</span>
                </div>
            </div>

            <div class="payment-methods">
                <h3>Payment Method</h3>
                <div class="payment-options">
                    <label class="payment-option">
                        <input type="radio" name="paymentMethod" value="cash" checked>
                        <span>Cash</span>
                    </label>
                    <label class="payment-option">
                        <input type="radio" name="paymentMethod" value="gcash">
                        <span>GCash</span>
                    </label>
                    <label class="payment-option">
                        <input type="radio" name="paymentMethod" value="bank">
                        <span>Bank Transfer</span>
                    </label>
                </div>
            </div>

            <div class="cash-payment" id="cashPayment">
                <div class="form-group">
                    <label for="amountReceived">Amount Received:</label>
                    <input type="number" id="amountReceived" step="0.01" min="0" class="form-control" placeholder="0.00">
                </div>
                <div class="change-display">
                    <span>Change: </span>
                    <span id="changeAmount">₱0.00</span>
                </div>
            </div>

            <div class="modal-actions">
                <button class="action-btn cancel" id="cancelPayment">Cancel</button>
                <button class="action-btn primary" id="confirmPayment">Complete Payment</button>
            </div>
        </div>
    </div>

    <!-- Walk-in Order Modal -->
    <div class="modal" id="walkInModal">
        <div class="modal-content">
            <button class="modal-close" id="walkInModalClose">×</button>
            <h2 class="modal-title">Add Walk-in Order</h2>
            
            <div class="walkin-form">
                <div class="form-group">
                    <label>Customer Name:</label>
                    <input type="text" id="walkInCustomerName" class="form-control" placeholder="Enter customer name">
                </div>
                
                <div class="form-group">
                    <label>Phone Number (Optional):</label>
                    <input type="tel" id="walkInCustomerPhone" class="form-control" placeholder="Enter phone number">
                </div>
                
                <div class="form-group">
                    <label>Order Type:</label>
                    <select id="walkInOrderType" class="form-control">
                        <option value="pickup">Pickup</option>
                        <option value="delivery">Delivery</option>
                    </select>
                </div>
                
                <div class="form-group delivery-address hidden" id="deliveryAddressGroup">
                    <label>Delivery Address:</label>
                    <textarea id="walkInDeliveryAddress" class="form-control" rows="3" placeholder="Enter delivery address"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Notes:</label>
                    <textarea id="walkInNotes" class="form-control" rows="3" placeholder="Additional notes..."></textarea>
                </div>
            </div>

            <div class="modal-actions">
                <button class="action-btn cancel" id="cancelWalkIn">Cancel</button>
                <button class="action-btn primary" id="saveWalkIn">Create Order</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast" id="toast"></div>

    <script>
        // Check if user is logged in as staff
        function checkStaffAuth() {
            const currentUser = Auth.getCurrentUser();
            if (!currentUser || !currentUser.isStaff) {
                window.location.href = 'index.html';
                return false;
            }
            document.getElementById('staffName').textContent = currentUser.fullName || currentUser.staffId;
            return true;
        }

        // Initialize staff system
        if (!checkStaffAuth()) {
            throw new Error('Unauthorized access');
        }

        // Enhanced Staff Dashboard Class
        class EnhancedStaffDashboard {
            constructor() {
                this.products = [];
                this.orders = [];
                this.walkInOrders = JSON.parse(localStorage.getItem('walkInOrders') || '[]');
                this.notifications = JSON.parse(localStorage.getItem('staffNotifications') || '[]');
                this.comprehensiveStats = null; // Will be loaded from database
                this.currentSection = 'dashboard';
                this.currentPage = 1;
                this.itemsPerPage = 10;
                this.currentEditingProduct = null;
                this.currentEditingOrder = null;
                this.cart = [];
                this.currentSearchQuery = '';
                this.currentCategory = null;
                
                this.initializeEventListeners();
                this.loadData();
                this.startOrderPolling();
                this.updateNotifications();
                this.setDefaultDates();
            }

            setDefaultDates() {
                const today = new Date();
                const oneMonthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                
                document.getElementById('dashboardStartDate').value = oneMonthAgo.toISOString().split('T')[0];
                document.getElementById('dashboardEndDate').value = today.toISOString().split('T')[0];
                document.getElementById('orderStartDate').value = oneMonthAgo.toISOString().split('T')[0];
                document.getElementById('orderEndDate').value = today.toISOString().split('T')[0];
            }

            async loadData() {
                await this.loadProducts();
                await this.loadOrders();
                await this.loadComprehensiveStats();
                this.updateStats();
                this.renderCurrentSection();
            }

            // Load comprehensive statistics from all collections
            async loadComprehensiveStats() {
                try {
                    // We'll use a dummy user ID to get overall statistics
                    // In a real system, you might want a dedicated staff statistics endpoint
                    const response = await fetch('API_CONFIG.getApiUrl("/orders/stats/staff-overview")');
                    
                    if (response.ok) {
                        this.comprehensiveStats = await response.json();
                    } else {
                        // Fallback: fetch from all collections manually
                        console.log('📊 Staff Dashboard - Fetching comprehensive stats manually...');
                        await this.loadStatsFromAllCollections();
                    }
                } catch (error) {
                    console.error('Error loading comprehensive stats:', error);
                    await this.loadStatsFromAllCollections();
                }
            }

            // Fallback method to manually fetch stats from all collections
            async loadStatsFromAllCollections() {
                try {
                    // Get orders from all collections
                    const allOrdersResponse = await fetch('API_CONFIG.getApiUrl("/orders")');
                    let allOrders = [];
                    
                    if (allOrdersResponse.ok) {
                        allOrders = await allOrdersResponse.json();
                    }
                    
                    // Count orders by collection and status
                    this.comprehensiveStats = {
                        totalPending: this.orders.filter(o => o.collection === 'pending').length,
                        totalAccepted: this.orders.filter(o => o.collection === 'accepted').length,
                        totalDelivered: this.orders.filter(o => o.collection === 'delivered').length,
                        totalRevenue: this.orders.filter(o => o.collection === 'delivered').reduce((sum, order) => {
                            return sum + (parseFloat(order.total) || 0);
                        }, 0)
                    };
                    
                    console.log('📊 Comprehensive stats loaded:', this.comprehensiveStats);
                } catch (error) {
                    console.error('Error loading manual stats:', error);
                    this.comprehensiveStats = {
                        totalPending: this.orders.filter(o => o.collection === 'pending').length,
                        totalAccepted: this.orders.filter(o => o.collection === 'accepted').length,
                        totalDelivered: this.orders.filter(o => o.collection === 'delivered').length,
                        totalRevenue: 0
                    };
                }
            }

            async loadProducts() {
                try {
                    const response = await fetch('API_CONFIG.getApiUrl("/products")');
                    if (!response.ok) throw new Error('Failed to fetch products');
                    
                    let products = await response.json();
                    this.products = products.map(product => ({
                        id: product._id,
                        name: product.name,
                        price: (() => {
                            const toNumber = (val) => {
                                if (val === null || val === undefined) return NaN;
                                if (typeof val === 'object' && val.$numberDecimal !== undefined) return parseFloat(val.$numberDecimal);
                                return parseFloat(val);
                            };
                            const candidates = [product.SellingPrice, product.sellingPrice, product.Price, product.price];
                            for (const c of candidates) {
                                const n = toNumber(c);
                                if (!isNaN(n)) return n;
                            }
                            return 0;
                        })(),
                        category: this.mapDbCategoryToLocal(product.category),
                        image: product.image || 'images/sanrico_logo_1.png',
                        stock: product.stockQuantity || 0,
                        description: product.description || 'No description available.'
                    }));
                } catch (error) {
                    console.error('Error loading products:', error);
                    this.products = [];
                }
            }

            async loadOrders() {
                try {
                    // Fetch orders from all collections (pending, accepted, delivered)
                    const response = await fetch('API_CONFIG.getApiUrl("/orders/all-staff")');
                    if (!response.ok) throw new Error('Failed to fetch orders');
                    
                    this.orders = await response.json();
                    console.log('📊 Staff Dashboard - Loaded orders from all collections:', this.orders.length);
                    console.log('📋 Orders breakdown:', {
                        pending: this.orders.filter(o => o.collection === 'pending').length,
                        accepted: this.orders.filter(o => o.collection === 'accepted').length,
                        delivered: this.orders.filter(o => o.collection === 'delivered').length
                    });
                    
                    // Debug: Log first few orders to see their structure
                    console.log('🔍 Sample orders:', this.orders.slice(0, 3).map(o => ({
                        id: o._id?.slice(-6),
                        collection: o.collection,
                        status: o.status,
                        displayStatus: o.displayStatus,
                        orderNumber: o.orderNumber
                    })));
                    
                    this.checkForNewOrders();
                } catch (error) {
                    console.error('Error loading orders:', error);
                    this.orders = [];
                }
            }

            checkForNewOrders() {
                const storedOrderCount = parseInt(localStorage.getItem('lastOrderCount') || '0');
                const currentOrderCount = this.orders.length;
                
                if (currentOrderCount > storedOrderCount) {
                    const newOrdersCount = currentOrderCount - storedOrderCount;
                    this.addNotification({
                        title: `New Order ${newOrdersCount}`,
                        description: `New orders have been placed`,
                        time: new Date(),
                        type: 'order'
                    });
                }
                
                localStorage.setItem('lastOrderCount', currentOrderCount.toString());
            }

            startOrderPolling() {
                setInterval(async () => {
                    await this.loadOrders();
                    await this.loadComprehensiveStats();
                    this.updateStats();
                    if (this.currentSection === 'orders') {
                        this.renderOrders();
                    }
                }, 30000);
            }

            addNotification(notification) {
                this.notifications.unshift({
                    ...notification,
                    id: Date.now(),
                    read: false
                });
                
                if (this.notifications.length > 50) {
                    this.notifications = this.notifications.slice(0, 50);
                }
                
                localStorage.setItem('staffNotifications', JSON.stringify(this.notifications));
                this.updateNotifications();
                showToast(notification.message, 'info');
            }

            updateNotifications() {
                const badge = document.getElementById('notificationBadge');
                const list = document.getElementById('notificationList');
                
                const unreadCount = this.notifications.filter(n => !n.read).length;
                badge.textContent = unreadCount;
                badge.style.display = unreadCount > 0 ? 'flex' : 'none';
                
                list.innerHTML = this.notifications.length === 0 ? 
                    '<div class="no-notifications">No notifications</div>' :
                    this.notifications.map(notification => `
                        <div class="notification-item ${notification.read ? '' : 'unread'}" data-id="${notification.id}">
                            <div class="notification-content">
                                <div class="notification-title">${notification.title}</div>
                                <div class="notification-message">${notification.description}</div>
                                <div class="notification-time">${this.formatTime(notification.time)}</div>
                            </div>
                        </div>
                    `).join('');
            }

            formatTime(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                
                if (diff < 60000) return 'Just now';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
                return date.toLocaleDateString();
            }

            mapDbCategoryToLocal(dbCategory) {
                switch(dbCategory) {
                    case 'Power-Tools': return 'power-tools';
                    case 'Hand-Tools': return 'hand-tools';
                    case 'Building-Materials': return 'building-materials';
                    case 'Plumbing': return 'plumbing';
                    case 'Electrical': return 'electrical';
                    default: return dbCategory.toLowerCase().replace(/\s+/g, '-');
                }
            }

            formatCategoryName(category) {
                switch(category) {
                    case 'power-tools': return 'Power Tools';
                    case 'hand-tools': return 'Hand Tools';
                    case 'building-materials': return 'Building Materials';
                    case 'plumbing': return 'Plumbing';
                    case 'electrical': return 'Electrical';
                    default: return category.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                }
            }

            updateStats() {
                // Show loading animations (non-blocking)
                if (typeof showLoadingStats === 'function') {
                    showLoadingStats();
                }
                
                document.getElementById('totalProducts').textContent = this.products.length;
                
                // Use comprehensive stats if available, otherwise fall back to local calculations
                if (this.comprehensiveStats) {
                    // Count orders by their actual status in the database using comprehensive stats
                    const pendingOrders = this.comprehensiveStats.totalPending || this.orders.filter(order => {
                        const status = order.status?.toLowerCase();
                        return status === 'active' || status === 'pending';
                    }).length;
                    
                    const acceptedOrders = this.comprehensiveStats.totalAccepted || this.orders.filter(order => {
                        return order.collection === 'accepted' || order.displayStatus === 'approved';
                    }).length;
                    
                    const deliveredOrders = this.comprehensiveStats.totalDelivered || 0;
                    const totalRevenue = this.comprehensiveStats.totalRevenue || 0;
                    
                    // Calculate orders requiring action (pending + accepted)
                    const ordersRequiringAction = pendingOrders + acceptedOrders;
                    
                    document.getElementById('pendingOrders').textContent = pendingOrders;
                    document.getElementById('completedOrders').textContent = deliveredOrders;
                    document.getElementById('deliveredProducts').textContent = deliveredOrders;
                    
                    // Update badge with actionable orders count or "0 action/s required"
                    const ordersBadge = document.getElementById('ordersBadge');
                    if (ordersRequiringAction === 0) {
                        ordersBadge.textContent = '0 action/s required';
                        ordersBadge.style.fontSize = '0.7rem';
                        ordersBadge.style.padding = '2px 6px';
                    } else {
                        ordersBadge.textContent = ordersRequiringAction;
                        ordersBadge.style.fontSize = '';
                        ordersBadge.style.padding = '';
                    }
                    
                    document.getElementById('totalRevenue').textContent = `₱${totalRevenue.toFixed(2)}`;
                } else {
                    // Fallback to local calculations
                    const pendingOrders = this.orders.filter(order => {
                        const status = order.status?.toLowerCase();
                        return status === 'active' || status === 'pending';
                    }).length;
                    
                    const acceptedOrders = this.orders.filter(order => {
                        return order.collection === 'accepted' || order.displayStatus === 'approved';
                    }).length;
                    
                    const completedOrders = this.orders.filter(order => {
                        const status = order.status?.toLowerCase();
                        return status === 'completed' || status === 'delivered';
                    }).length;
                    
                    const totalRevenue = this.orders
                        .filter(order => {
                            const status = order.status?.toLowerCase();
                            return status === 'completed' || status === 'delivered';
                        })
                        .reduce((sum, order) => sum + (parseFloat(order.total) || 0), 0);
                    
                    // Calculate orders requiring action (pending + accepted)
                    const ordersRequiringAction = pendingOrders + acceptedOrders;
                    
                    document.getElementById('pendingOrders').textContent = pendingOrders;
                    document.getElementById('completedOrders').textContent = completedOrders;
                    document.getElementById('deliveredProducts').textContent = completedOrders;
                    
                    // Update badge with actionable orders count or "0 action/s required"
                    const ordersBadge = document.getElementById('ordersBadge');
                    if (ordersRequiringAction === 0) {
                        ordersBadge.textContent = '0 action/s required';
                        ordersBadge.style.fontSize = '0.7rem';
                        ordersBadge.style.padding = '2px 6px';
                    } else {
                        ordersBadge.textContent = ordersRequiringAction;
                        ordersBadge.style.fontSize = '';
                        ordersBadge.style.padding = '';
                    }
                    
                    document.getElementById('totalRevenue').textContent = `₱${totalRevenue.toFixed(2)}`;
                }
                
                // Walk-in orders count
                document.getElementById('walkInOrders').textContent = this.walkInOrders.length;
                
                // Update walk-in stats
                const today = new Date().toDateString();
                const thisWeek = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toDateString();
                const thisMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toDateString();
                
                document.getElementById('todayWalkIns').textContent = 
                    this.walkInOrders.filter(w => new Date(w.date).toDateString() === today).length;
                document.getElementById('weekWalkIns').textContent = 
                    this.walkInOrders.filter(w => new Date(w.date) >= new Date(thisWeek)).length;
                document.getElementById('monthWalkIns').textContent = 
                    this.walkInOrders.filter(w => new Date(w.date) >= new Date(thisMonth)).length;
            }

            initializeEventListeners() {
                // Sidebar navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        this.switchSection(e.currentTarget.dataset.section);
                    });
                });

                // Clickable stat cards navigation
                document.querySelectorAll('.stat-card.clickable').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const section = e.currentTarget.dataset.section;
                        this.switchSection(section);
                    });
                });

                // Notification events
                document.getElementById('notificationBtn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.getElementById('notificationDropdown').classList.toggle('show');
                });

                document.addEventListener('click', () => {
                    document.getElementById('notificationDropdown').classList.remove('show');
                });

                document.getElementById('clearAllBtn').addEventListener('click', () => {
                    this.notifications = [];
                    localStorage.setItem('staffNotifications', JSON.stringify(this.notifications));
                    this.updateNotifications();
                });

                // Dashboard events
                document.getElementById('refreshDashboard').addEventListener('click', () => {
                    this.loadData();
                    showToast('Dashboard refreshed', 'success');
                });

                // Product management events
                document.getElementById('categoryFilter').addEventListener('change', () => {
                    this.currentPage = 1;
                    this.renderProducts();
                });

                document.getElementById('productSearch').addEventListener('input', () => {
                    this.currentPage = 1;
                    this.renderProducts();
                });

                // Order management events
                document.getElementById('orderStartDate').addEventListener('change', () => {
                    this.renderOrders();
                });

                document.getElementById('orderEndDate').addEventListener('change', () => {
                    this.renderOrders();
                });

                document.getElementById('orderStatusFilter').addEventListener('change', () => {
                    this.renderOrders();
                });

                document.getElementById('paymentMethodFilter').addEventListener('change', () => {
                    this.renderOrders();
                });

                document.getElementById('refreshOrdersBtn').addEventListener('click', async () => {
                    await this.loadOrders();
                    this.renderOrders();
                    showToast('Orders refreshed', 'success');
                });

                // Walk-in events
                document.getElementById('clearWalkInListBtn').addEventListener('click', () => {
                    this.clearWalkInOrders();
                });

                // POS events
                this.initializePOSEvents();

                // Modal events
                this.initializeModalEvents();

                // Logout
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    this.handleLogout();
                });
            }

            initializePOSEvents() {
                // POS product search
                document.getElementById('posProductSearch').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.scanProduct();
                    }
                });

                document.getElementById('scanProductBtn').addEventListener('click', () => {
                    this.scanProduct();
                });

                // POS category filters
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        
                        // Clear search when switching categories
                        this.currentSearchQuery = '';
                        document.getElementById('posProductSearch').value = '';
                        
                        this.currentCategory = e.target.dataset.category;
                        this.renderPOSProducts(this.currentCategory || 'all');
                    });
                });

                // Cart actions
                document.getElementById('clearCartBtn').addEventListener('click', () => {
                    this.clearCart();
                });

                document.getElementById('newTransactionBtn').addEventListener('click', () => {
                    this.clearCart();
                    document.getElementById('customerName').value = '';
                    document.getElementById('customerPhone').value = '';
                });

                document.getElementById('checkoutBtn').addEventListener('click', () => {
                    this.showPaymentModal();
                });

                // Payment modal events
                document.getElementById('paymentModalClose').addEventListener('click', () => {
                    document.getElementById('paymentModal').classList.remove('show');
                });

                document.getElementById('cancelPayment').addEventListener('click', () => {
                    document.getElementById('paymentModal').classList.remove('show');
                });

                document.getElementById('confirmPayment').addEventListener('click', () => {
                    this.processPayment();
                });

                document.getElementById('amountReceived').addEventListener('input', () => {
                    this.calculateChange();
                });

                // Payment method change
                document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const cashPayment = document.getElementById('cashPayment');
                        if (e.target.value === 'cash') {
                            cashPayment.style.display = 'block';
                        } else {
                            cashPayment.style.display = 'none';
                        }
                    });
                });
            }

            initializeModalEvents() {
                // Product modal
                document.getElementById('productModalClose').addEventListener('click', () => {
                    document.getElementById('productModal').classList.remove('show');
                });

                document.getElementById('cancelEdit').addEventListener('click', () => {
                    document.getElementById('productModal').classList.remove('show');
                });

                document.getElementById('saveProduct').addEventListener('click', () => {
                    this.saveProductChanges();
                });

                // Order modal
                document.getElementById('orderModalClose').addEventListener('click', () => {
                    document.getElementById('orderModal').classList.remove('show');
                });

                document.getElementById('closeOrderModal').addEventListener('click', () => {
                    document.getElementById('orderModal').classList.remove('show');
                });

                document.getElementById('updateOrderStatus').addEventListener('click', () => {
                    this.updateOrderStatus();
                });

                // Walk-in modal
                document.getElementById('walkInModalClose').addEventListener('click', () => {
                    document.getElementById('walkInModal').classList.remove('show');
                });

                document.getElementById('cancelWalkIn').addEventListener('click', () => {
                    document.getElementById('walkInModal').classList.remove('show');
                });

                document.getElementById('saveWalkIn').addEventListener('click', () => {
                    this.saveWalkInOrder();
                });

                // File upload
                document.getElementById('dropZone').addEventListener('click', () => {
                    document.getElementById('fileInput').click();
                });

                document.getElementById('fileInput').addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFileSelect(e.target.files[0]);
                    }
                });

                document.getElementById('removeImageBtn').addEventListener('click', () => {
                    this.removeImage();
                });
            }

            switchSection(section) {
                // Update navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-section="${section}"]`).classList.add('active');

                // Update sections
                document.querySelectorAll('.content-section').forEach(sec => {
                    sec.classList.remove('active');
                });
                document.getElementById(`${section}-section`).classList.add('active');

                this.currentSection = section;
                this.currentPage = 1;
                this.renderCurrentSection();
            }

            renderCurrentSection() {
                switch(this.currentSection) {
                    case 'dashboard':
                        this.renderDashboard();
                        break;
                    case 'products':
                        this.renderProducts();
                        break;
                    case 'orders':
                        this.renderOrders();
                        break;
                    case 'walkin':
                        this.renderWalkInOrders();
                        break;
                    case 'cashier':
                        this.renderPOSProducts('all');
                        break;
                }
            }

            renderDashboard() {
                const activityList = document.getElementById('activityList');
                
                // Combine recent orders and walk-in orders for activity
                const recentActivities = [
                    ...this.orders.slice(0, 5).map(order => ({
                        type: 'order',
                        title: `New Order ${order.orderNumber || this.generateOrderNumber(order)}`,
                        description: `${order.fullName || order.buyerinfo || 'Unknown Customer'} - ₱${(parseFloat(order.total) || 0).toFixed(2)}`,
                        time: new Date(order.createdAt || order.original_date)
                    })),
                    ...this.walkInOrders.slice(0, 5).map(order => ({
                        type: 'walkin',
                        title: `Walk-in Order #${order.id.toString().slice(-6)}`,
                        description: `${order.customerName} - ₱${order.total.toFixed(2)}`,
                        time: new Date(order.date)
                    }))
                ].sort((a, b) => b.time - a.time).slice(0, 10);

                if (recentActivities.length === 0) {
                    activityList.innerHTML = '<div class="no-data">No recent activity</div>';
                    return;
                }

                activityList.innerHTML = recentActivities.map(activity => `
                    <div class="activity-item">
                        <div class="activity-icon ${activity.type}">
                            ${activity.type === 'order' ? '📋' : '🚶'}
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title}</div>
                            <div class="activity-description">${activity.description}</div>
                            <div class="activity-time">${this.formatTime(activity.time)}</div>
                        </div>
                    </div>
                `).join('');
            }

            renderProducts() {
                // Show loading animation
                showLoadingProducts();
                
                // Add small delay for better UX
                setTimeout(() => {
                    const tbody = document.getElementById('productsTableBody');
                    const categoryFilter = document.getElementById('categoryFilter').value;
                    const searchQuery = document.getElementById('productSearch').value.toLowerCase();
                    
                    let filteredProducts = this.products;
                    
                    if (categoryFilter !== 'all') {
                        filteredProducts = filteredProducts.filter(p => p.category === categoryFilter);
                    }
                    
                    if (searchQuery) {
                        filteredProducts = filteredProducts.filter(p => 
                            p.name.toLowerCase().includes(searchQuery)
                        );
                    }
                    
                    const start = (this.currentPage - 1) * this.itemsPerPage;
                    const end = start + this.itemsPerPage;
                    const displayed = filteredProducts.slice(start, end);

                    if (displayed.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="no-data">No products found</td></tr>';
                        return;
                    }

                    tbody.innerHTML = displayed.map(product => `
                        <tr>
                            <td>
                                <div class="product-image-cell">
                                    <img src="${product.image.startsWith('data:image') ? product.image : 'images/' + product.image}" 
                                         alt="${product.name}" 
                                         onerror="this.src='images/sanrico_logo_1.png'"
                                         class="product-table-image">
                                </div>
                            </td>
                            <td>
                                <div class="product-name-cell">
                                    <strong>${product.name}</strong>
                                </div>
                            </td>
                            <td>
                                <span class="category-badge">${this.formatCategoryName(product.category)}</span>
                            </td>
                            <td>
                                <span class="product-price-cell">₱${product.price.toFixed(2)}</span>
                            </td>
                            <td>
                                <span class="stock-quantity ${product.stock === 0 ? 'stock-out' : product.stock <= 5 ? 'stock-low' : 'stock-in'}">${product.stock}</span>
                            </td>
                            <td>
                                <span class="stock-status ${product.stock === 0 ? 'out-of-stock' : product.stock <= 5 ? 'low-stock' : 'in-stock'}">
                                    ${product.stock === 0 ? 'Out of Stock' : product.stock <= 5 ? 'Low Stock' : 'In Stock'}
                                </span>
                            </td>
                            <td>
                                <button class="action-btn small primary" onclick="staffDashboard.editProduct('${product.id}')">Edit</button>
                            </td>
                        </tr>
                    `).join('');

                    this.updatePagination('productsPagination', filteredProducts.length);
                }, 250); // 250ms delay to show loading animation
            }

            renderOrders() {
                // Show loading animation
                showLoadingOrders();
                
                // Add small delay for better UX 
                setTimeout(() => {
                    const tbody = document.getElementById('ordersTableBody');
                    const statusFilter = document.getElementById('orderStatusFilter').value;
                    const paymentFilter = document.getElementById('paymentMethodFilter').value;
                    const startDate = document.getElementById('orderStartDate').value;
                    const endDate = document.getElementById('orderEndDate').value;
                    
                    console.log('🔍 Rendering orders with filter:', statusFilter);
                    console.log('📊 Total orders before filtering:', this.orders.length);
                    
                    let filteredOrders = this.orders;
                    
                    // Filter by status - use displayStatus for accurate filtering
                    if (statusFilter !== 'all') {
                        filteredOrders = filteredOrders.filter(o => {
                            const displayStatus = o.displayStatus || o.status;
                            const matches = displayStatus === statusFilter;
                            if (!matches) {
                                console.log(`❌ Order ${o._id?.slice(-6)} filtered out: displayStatus="${displayStatus}", filter="${statusFilter}"`);
                            }
                            return matches;
                        });
                    }
                    
                    console.log('📊 Orders after status filtering:', filteredOrders.length);
                    
                    // Filter by payment method
                    if (paymentFilter !== 'all') {
                        filteredOrders = filteredOrders.filter(o => (o.paymentMethod || 'cod') === paymentFilter);
                    }
                    
                    // Filter by date range
                    if (startDate) {
                        filteredOrders = filteredOrders.filter(o => {
                            const orderDate = new Date(o.createdAt || o.orderDate || o.original_date);
                            return orderDate >= new Date(startDate);
                        });
                    }
                    
                    if (endDate) {
                        filteredOrders = filteredOrders.filter(o => {
                            const orderDate = new Date(o.createdAt || o.orderDate || o.original_date);
                            return orderDate <= new Date(endDate + 'T23:59:59');
                        });
                    }
                    
                    console.log('📊 Final filtered orders:', filteredOrders.length);
                    
                    const start = (this.currentPage - 1) * this.itemsPerPage;
                    const end = start + this.itemsPerPage;
                    const displayed = filteredOrders.slice(start, end);

                    if (displayed.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="9" class="no-data">No orders found</td></tr>';
                        return;
                    }

                    tbody.innerHTML = displayed.map(order => {
                        // Determine the correct status display based on collection and status
                        let statusDisplay = order.displayStatus || order.status;
                        let statusClass = statusDisplay;
                        
                        // Map status classes for CSS
                        if (statusDisplay === 'pending' || order.status === 'active') {
                            statusClass = 'pending';
                            statusDisplay = 'Pending';
                        } else if (statusDisplay === 'approved') {
                            statusClass = 'approved';
                            statusDisplay = 'Approved';
                        } else if (statusDisplay === 'delivered') {
                            statusClass = 'delivered';
                            statusDisplay = 'Delivered';
                        }
                        
                        return `
                            <tr data-collection="${order.collection || 'unknown'}">
                                <td>${order.orderNumber || this.generateOrderNumber(order)}</td>
                                <td>${order.fullName || order.buyerinfo || 'N/A'}</td>
                                <td>${(order.itemsordered || []).length} items</td>
                                <td>₱${(parseFloat(order.total) || 0).toFixed(2)}</td>
                                <td>
                                    <span class="payment-method ${order.paymentMethod || 'cod'}">
                                        ${this.formatPaymentMethod(order.paymentMethod || 'cod')}
                                    </span>
                                </td>
                                <td>
                                    <span class="shipping-info">
                                        ${order.address ? 'Delivery' : 'Pickup'}
                                    </span>
                                </td>
                                <td>${new Date(order.orderDate || order.createdAt || order.original_date).toLocaleString()}</td>
                                <td>
                                    <span class="status-badge ${statusClass.toLowerCase()}">
                                        ${statusDisplay}
                                    </span>
                                </td>
                                <td>
                                    <button class="action-btn small" onclick="staffDashboard.viewOrder('${order._id}')">View</button>
                                </td>
                            </tr>
                        `;
                    }).join('');

                    this.updatePagination('ordersPagination', filteredOrders.length);
                }, 300); // 300ms delay to show loading animation
            }

            renderWalkInOrders() {
                // Show loading animation
                showLoadingWalkInOrders();
                
                setTimeout(() => {
                const tbody = document.getElementById('walkInOrdersTableBody');

                if (this.walkInOrders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="no-data">No walk-in orders found</td></tr>';
                    return;
                }

                const sortedOrders = [...this.walkInOrders].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                tbody.innerHTML = sortedOrders.map(order => `
                    <tr>
                        <td>#${order.id.toString().slice(-6)}</td>
                        <td>${order.customerName}</td>
                        <td>${order.items.length} items</td>
                        <td>₱${order.total.toFixed(2)}</td>
                        <td>
                            <span class="payment-method ${order.paymentMethod}">
                                ${this.formatPaymentMethod(order.paymentMethod)}
                            </span>
                        </td>
                        <td>${new Date(order.date).toLocaleString()}</td>
                        <td>
                            <button class="action-btn small" onclick="staffDashboard.viewWalkInOrder('${order.id}')">View</button>
                        </td>
                    </tr>
                `).join('');
                }, 300); // 300ms delay to show loading animation
            }

            renderPOSProducts(category = 'all') {
                this.currentCategory = category;
                
                // If there's an active search, use filterPOSProducts instead
                if (this.currentSearchQuery) {
                    this.filterPOSProducts();
                    return;
                }
                
                const grid = document.getElementById('posProductsGrid');
                
                let filteredProducts = this.products.filter(p => p.stock > 0);
                
                if (category !== 'all') {
                    filteredProducts = filteredProducts.filter(p => p.category === category);
                }

                // Sort by newest first (if available)
                filteredProducts.sort((a, b) => {
                    if (a.createdAt && b.createdAt) {
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    }
                    return b.id.localeCompare(a.id);
                });

                if (filteredProducts.length === 0) {
                    grid.innerHTML = '<div class="no-data">No products available</div>';
                    return;
                }

                grid.innerHTML = filteredProducts.map(product => `
                    <div class="pos-product-card" onclick="staffDashboard.addToCart('${product.id}')">
                        <div class="pos-product-image">
                            <img src="${product.image.startsWith('data:image') ? product.image : 'images/' + product.image}" 
                                 alt="${product.name}" 
                                 onerror="this.src='images/sanrico_logo_1.png'">
                        </div>
                        <div class="pos-product-info">
                            <h4>${product.name}</h4>
                            <div class="pos-product-price">₱${product.price.toFixed(2)}</div>
                            <div class="pos-product-stock">Stock: ${product.stock}</div>
                        </div>
                    </div>
                `).join('');
            }

            // POS Methods
            scanProduct() {
                const query = document.getElementById('posProductSearch').value.trim().toLowerCase();
                
                // If query is empty, show all products in current category
                if (!query) {
                    this.currentSearchQuery = '';
                    this.renderPOSProducts(this.currentCategory || 'all');
                    return;
                }

                // Store the search query and filter products
                this.currentSearchQuery = query;
                this.filterPOSProducts();
            }

            filterPOSProducts() {
                const grid = document.getElementById('posProductsGrid');
                const category = this.currentCategory || 'all';
                const query = this.currentSearchQuery || '';
                
                let filteredProducts = this.products.filter(p => p.stock > 0);
                
                // Filter by category
                if (category !== 'all') {
                    filteredProducts = filteredProducts.filter(p => p.category === category);
                }
                
                // Filter by search query
                if (query) {
                    filteredProducts = filteredProducts.filter(p => 
                        p.name.toLowerCase().includes(query.toLowerCase())
                    );
                }

                // Sort by newest first
                filteredProducts.sort((a, b) => {
                    if (a.createdAt && b.createdAt) {
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    }
                    return b.id.localeCompare(a.id);
                });

                if (filteredProducts.length === 0) {
                    grid.innerHTML = '<div class="no-data">No products found</div>';
                    return;
                }

                grid.innerHTML = filteredProducts.map(product => `
                    <div class="pos-product-card" onclick="staffDashboard.addToCart('${product.id}')">
                        <div class="pos-product-image">
                            <img src="${product.image.startsWith('data:image') ? product.image : 'images/' + product.image}" 
                                 alt="${product.name}" 
                                 onerror="this.src='images/sanrico_logo_1.png'">
                        </div>
                        <div class="pos-product-info">
                            <h4>${product.name}</h4>
                            <div class="pos-product-price">₱${product.price.toFixed(2)}</div>
                            <div class="pos-product-stock">Stock: ${product.stock}</div>
                        </div>
                    </div>
                `).join('');
            }

            addToCart(productId) {
                const product = this.products.find(p => p.id === productId);
                if (!product || product.stock === 0) {
                    showToast('Product not available', 'error');
                    return;
                }

                const existingItem = this.cart.find(item => item.id === productId);
                if (existingItem) {
                    if (existingItem.quantity < product.stock) {
                        existingItem.quantity++;
                    } else {
                        showToast('Insufficient stock', 'error');
                        return;
                    }
                } else {
                    this.cart.push({
                        ...product,
                        quantity: 1
                    });
                }

                this.updateCartDisplay();
                showToast(`${product.name} added to cart`, 'success');
            }

            updateCartDisplay() {
                const cartItems = document.getElementById('cartItems');
                const cartCount = document.getElementById('cartCount');
                const checkoutBtn = document.getElementById('checkoutBtn');
                
                if (this.cart.length === 0) {
                    cartItems.innerHTML = '<div class="empty-cart"><p>No items in cart</p></div>';
                    cartCount.textContent = '0 items';
                    checkoutBtn.disabled = true;
                } else {
                    const totalItems = this.cart.reduce((sum, item) => sum + item.quantity, 0);
                    cartCount.textContent = `${totalItems} item${totalItems > 1 ? 's' : ''}`;
                    checkoutBtn.disabled = false;
                    
                    cartItems.innerHTML = this.cart.map((item, index) => `
                        <div class="cart-item">
                            <div class="cart-item-info">
                                <div class="cart-item-name">${item.name}</div>
                                <div class="cart-item-price">₱${item.price.toFixed(2)} each</div>
                            </div>
                            <div class="cart-item-controls">
                                <button class="qty-btn" onclick="staffDashboard.updateCartQuantity(${index}, -1)">-</button>
                                <span class="cart-quantity">${item.quantity}</span>
                                <button class="qty-btn" onclick="staffDashboard.updateCartQuantity(${index}, 1)">+</button>
                                <button class="remove-btn" onclick="staffDashboard.removeFromCart(${index})">×</button>
                            </div>
                            <div class="cart-item-total">₱${(item.price * item.quantity).toFixed(2)}</div>
                        </div>
                    `).join('');
                }

                this.updateCartTotals();
            }

            updateCartQuantity(index, change) {
                const item = this.cart[index];
                const newQuantity = item.quantity + change;
                
                if (newQuantity <= 0) {
                    this.removeFromCart(index);
                } else if (newQuantity <= item.stock) {
                    item.quantity = newQuantity;
                    this.updateCartDisplay();
                } else {
                    showToast('Insufficient stock', 'error');
                }
            }

            removeFromCart(index) {
                this.cart.splice(index, 1);
                this.updateCartDisplay();
            }

            clearCart() {
                this.cart = [];
                this.updateCartDisplay();
            }

            updateCartTotals() {
                const subtotal = this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const total = subtotal;

                document.getElementById('subtotal').textContent = `₱${subtotal.toFixed(2)}`;
                document.getElementById('total').textContent = `₱${total.toFixed(2)}`;
            }

            showPaymentModal() {
                if (this.cart.length === 0) return;

                const total = this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0) * 1.12;
                document.getElementById('paymentTotal').textContent = `₱${total.toFixed(2)}`;
                document.getElementById('amountReceived').value = '';
                document.getElementById('changeAmount').textContent = '₱0.00';
                document.getElementById('paymentModal').classList.add('show');
            }

            calculateChange() {
                const total = parseFloat(document.getElementById('paymentTotal').textContent.replace('₱', ''));
                const received = parseFloat(document.getElementById('amountReceived').value) || 0;
                const change = received - total;
                document.getElementById('changeAmount').textContent = `₱${Math.max(0, change).toFixed(2)}`;
            }

            processPayment() {
                const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
                const total = parseFloat(document.getElementById('paymentTotal').textContent.replace('₱', ''));
                
                if (paymentMethod === 'cash') {
                    const received = parseFloat(document.getElementById('amountReceived').value) || 0;
                    if (received < total) {
                        showToast('Insufficient amount received', 'error');
                        return;
                    }
                }

                const customerName = document.getElementById('customerName').value.trim() || 'Walk-in Customer';
                const customerPhone = document.getElementById('customerPhone').value.trim();

                const walkInOrder = {
                    id: Date.now(),
                    customerName,
                    customerPhone,
                    items: [...this.cart],
                    subtotal: this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                    total,
                    paymentMethod,
                    date: new Date().toISOString(),
                    type: 'walkin'
                };

                this.walkInOrders.unshift(walkInOrder);
                localStorage.setItem('walkInOrders', JSON.stringify(this.walkInOrders));

                // Update product stock
                this.cart.forEach(item => {
                    const product = this.products.find(p => p.id === item.id);
                    if (product) {
                        product.stock -= item.quantity;
                    }
                });

                document.getElementById('paymentModal').classList.remove('show');
                this.clearCart();
                document.getElementById('customerName').value = '';
                document.getElementById('customerPhone').value = '';
                
                this.updateStats();
                showToast('Payment processed successfully', 'success');
            }

            // Utility Methods
            formatPaymentMethod(method) {
                switch(method) {
                    case 'cash': return 'Cash';
                    case 'gcash': return 'GCash';
                    case 'bank': return 'Bank Transfer';
                    default: return 'Unknown';
                }
            }

            updatePagination(containerId, totalItems) {
                const container = document.getElementById(containerId);
                const totalPages = Math.ceil(totalItems / this.itemsPerPage);
                
                if (totalPages <= 1) {
                    container.innerHTML = '';
                    return;
                }

                container.innerHTML = '';
                for (let i = 1; i <= totalPages; i++) {
                    const button = document.createElement('button');
                    button.textContent = i;
                    button.className = `page-btn ${i === this.currentPage ? 'active' : ''}`;
                    button.onclick = () => {
                        this.currentPage = i;
                        this.renderCurrentSection();
                    };
                    container.appendChild(button);
                }
            }

            // Product Management Methods
            editProduct(id) {
                const product = this.products.find(p => p.id === id);
                if (!product) return;
                
                this.currentEditingProduct = product;
                
                document.getElementById('productName').value = product.name;
                document.getElementById('productStock').value = product.stock;
                
                if (product.image && !product.image.includes('sanrico_logo_1.png')) {
                    const previewImg = document.getElementById('previewImg');
                    const imagePreview = document.getElementById('imagePreview');
                    const removeBtn = document.getElementById('removeImageBtn');
                    
                    previewImg.src = product.image.startsWith('data:image') ? product.image : 'images/' + product.image;
                    imagePreview.classList.remove('hidden');
                    removeBtn.classList.remove('hidden');
                }
                
                document.getElementById('productModal').classList.add('show');
            }

            async saveProductChanges() {
                if (!this.currentEditingProduct) return;
                
                try {
                    const stock = parseInt(document.getElementById('productStock').value);
                    const previewImg = document.getElementById('previewImg');
                    
                    const updateData = {
                        stockQuantity: stock
                    };
                    
                    if (previewImg.src && !previewImg.src.includes('sanrico_logo_1.png')) {
                        updateData.image = previewImg.src;
                    }
                    
                    const response = await fetch(`API_CONFIG.getApiUrl("/products/${this.currentEditingProduct.id}")`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });
                    
                    if (!response.ok) throw new Error('Failed to update product');
                    
                    const productIndex = this.products.findIndex(p => p.id === this.currentEditingProduct.id);
                    if (productIndex !== -1) {
                        this.products[productIndex].stock = stock;
                        if (updateData.image) {
                            this.products[productIndex].image = updateData.image;
                        }
                    }
                    
                    document.getElementById('productModal').classList.remove('show');
                    this.renderProducts();
                    showToast('Product updated successfully', 'success');
                } catch (error) {
                    console.error('Error updating product:', error);
                    showToast('Failed to update product', 'error');
                }
            }

            // Order Management Methods
            viewOrder(orderId) {
                const order = this.orders.find(o => o._id === orderId);
                if (!order) return;
                
                this.currentEditingOrder = order;
                
                // Populate order ID and date with improved formatting
                const orderNumber = order.orderNumber || this.generateOrderNumber(order);
                document.getElementById('staffModalOrderId').textContent = orderNumber;
                document.getElementById('staffModalOrderDate').textContent = new Date(order.orderDate || order.createdAt || order.original_date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Resolve delivery address if it's an address ID
                this.resolveDeliveryAddress(order).then((resolvedAddress) => {
                    // Populate customer information with resolved address
                const customerInfo = document.getElementById('staffCustomerInfo');
                customerInfo.innerHTML = `
                    <div class="info-row">
                        <span class="info-label">Customer Name</span>
                        <span class="info-value">${order.fullName || order.buyerinfo || 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Email</span>
                        <span class="info-value">${order.email || 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Phone</span>
                        <span class="info-value">${order.phoneNumber || 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Delivery Address</span>
                            <span class="info-value">${resolvedAddress || 'Pickup'}</span>
                    </div>
                    ${order.notes && order.notes !== 'no additional notes' ? `
                        <div class="info-row">
                            <span class="info-label">Notes</span>
                            <span class="info-value">${order.notes}</span>
                        </div>
                    ` : ''}
                `;
                });
                
                // Populate order items with modern styling
                const itemsList = document.getElementById('staffModalOrderItems');
                itemsList.innerHTML = (order.itemsordered || []).map(item => `
                    <div class="order-item-modern">
                        <div class="item-info-modern">
                            <div class="item-name-modern">${item.item_name || 'Unknown Item'}</div>
                            <div class="item-details-modern">Qty: ${item.amount_per_item || 1} × ₱${(parseFloat(item.price_per_item) || 0).toFixed(2)}</div>
                        </div>
                        <div class="item-total-modern">₱${(parseFloat(item.total_item_price) || 0).toFixed(2)}</div>
                    </div>
                `).join('');
                
                // Calculate and populate totals
                const subtotal = (order.itemsordered || []).reduce((total, item) => total + (parseFloat(item.total_item_price) || 0), 0);
                const total = parseFloat(order.total) || subtotal;
                
                document.getElementById('staffModalSubtotal').textContent = `₱${subtotal.toFixed(2)}`;
                document.getElementById('staffModalTotal').textContent = `₱${total.toFixed(2)}`;
                
                // Populate staff technical information with better formatting
                const technicalInfo = document.getElementById('staffOrderTechnicalInfo');
                technicalInfo.innerHTML = `
                    <div class="info-row">
                        <span class="info-label">Database ID</span>
                        <span class="info-value technical-value">${order._id || 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">User ID</span>
                        <span class="info-value technical-value">${order.userId || 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Created At</span>
                        <span class="info-value">${order.createdAt || order.original_date ? new Date(order.createdAt || order.original_date).toLocaleString() : 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Order Source</span>
                        <span class="info-value">${order.source || 'checkout_page'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Current Status</span>
                        <span class="info-value">
                            <span class="staff-status-badge ${(order.status || 'pending').toLowerCase()}">${order.status || 'Pending'}</span>
                        </span>
                    </div>
                `;
                
                // Populate payment information
                const paymentInfo = document.getElementById('staffPaymentInfo');
                const hasProofOfPayment = order.proofOfPayment && order.proofOfPayment.trim() !== '';
                
                paymentInfo.innerHTML = `
                    <div class="payment-method-modern">
                        <div class="payment-icon">💳</div>
                        <div>
                            <strong>${this.formatPaymentMethod(order.paymentMethod || 'cod')}</strong>
                            ${order.paymentReference ? `<div style="font-size: 0.85rem; color: #666;">Ref: ${order.paymentReference}</div>` : ''}
                            ${order.paymentAmount ? `<div style="font-size: 0.85rem; color: #666;">Amount: ₱${parseFloat(order.paymentAmount).toFixed(2)}</div>` : ''}
                        </div>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Payment Status</span>
                        <span class="info-value">
                            ${hasProofOfPayment ? 
                                `<span style="color: #28a745; font-weight: 500;">✓ Proof Available</span>
                                 <button type="button" class="proof-preview-btn" onclick="staffDashboard.showProofPreview('${order.proofOfPayment}')">
                                     <i class="fa fa-eye"></i> Preview Proof
                                 </button>` : 
                                `<span style="color: #dc3545; font-weight: 500;">⚠ No Proof Uploaded</span>`
                            }
                        </span>
                    </div>
                    ${order.paymentVerified !== undefined ? `
                        <div class="info-row">
                            <span class="info-label">Payment Verified</span>
                            <span class="info-value">
                                <span class="staff-status-badge ${order.paymentVerified ? 'completed' : 'pending'}">
                                    ${order.paymentVerified ? 'Verified' : 'Pending Verification'}
                                </span>
                            </span>
                        </div>
                    ` : ''}
                `;
                
                document.getElementById('orderStatusSelect').value = order.status === 'active' ? 'pending' : (order.status || 'pending');
                document.getElementById('orderModal').classList.add('show');
            }

            // New method to resolve delivery address IDs to readable addresses
            async resolveDeliveryAddress(order) {
                const address = order.address;
                
                // If address starts with 'addr_', it's an address ID that needs resolution
                if (address && address.startsWith('addr_')) {
                    try {
                        // Get user ID from the order
                        const userId = order.userId;
                        if (!userId) {
                            console.warn('No user ID found in order for address resolution');
                            return address; // Return the raw address ID if no user ID
                        }
                        
                        // Fetch user addresses from the database
                        const response = await fetch(`API_CONFIG.getApiUrl("/user-addresses?userId=${userId}")`);
                        if (!response.ok) {
                            console.warn('Failed to fetch user addresses for resolution');
                            return address; // Return the raw address ID on fetch failure
                        }
                        
                        const addresses = await response.json();
                        
                        // Find the matching address
                        const matchedAddress = addresses.find(addr => {
                            const id = addr.id || addr._id || (addr._id && addr._id.toString());
                            return id === address;
                        });
                        
                        if (matchedAddress) {
                            // Format the address nicely
                            const formattedAddress = `${matchedAddress.label ? `[${matchedAddress.label}] ` : ''}${matchedAddress.streetAddress}, ${matchedAddress.barangay}, ${matchedAddress.city}, ${matchedAddress.province}, ${matchedAddress.postalCode}`;
                            return formattedAddress;
                        } else {
                            console.warn('Address ID not found in user addresses:', address);
                            return `Address ID: ${address} (Not found)`;
                        }
                        
                    } catch (error) {
                        console.error('Error resolving address:', error);
                        return `Address ID: ${address} (Resolution failed)`;
                    }
                } else {
                    // If it's not an address ID, return as-is
                    return address || 'Pickup';
                }
            }

            async updateOrderStatus() {
                if (!this.currentEditingOrder) return;
                
                try {
                    const newStatus = document.getElementById('orderStatusSelect').value;
                    const currentStatus = this.currentEditingOrder.status;
                    const order = this.currentEditingOrder;
                    
                    // Check if the status is already set to the selected value
                    // Map 'active' to 'pending' for comparison
                    const normalizedCurrentStatus = currentStatus === 'active' ? 'pending' : currentStatus;
                    
                    if (normalizedCurrentStatus === newStatus) {
                        const statusDisplayName = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                        showToast(`Error updating status: already set as ${statusDisplayName}`, 'error');
                        return;
                    }
                    
                    // Determine current effective status based on collection and status
                    let effectiveCurrentStatus = normalizedCurrentStatus;
                    if (order.collection === 'accepted' || order.displayStatus === 'approved') {
                        effectiveCurrentStatus = 'approved';
                    } else if (order.collection === 'delivered' || order.displayStatus === 'delivered') {
                        effectiveCurrentStatus = 'delivered';
                    }
                    
                    // Prevent backward status transitions
                    if (effectiveCurrentStatus === 'approved' && newStatus === 'pending') {
                        showToast('Error: Cannot change approved orders back to pending status', 'error');
                        return;
                    }
                    
                    if (effectiveCurrentStatus === 'delivered' && (newStatus === 'pending' || newStatus === 'approved')) {
                        showToast('Error: Cannot change delivered orders back to previous status', 'error');
                        return;
                    }
                    
                    // Check if trying to change from pending/active to delivered without going through approved
                    if ((normalizedCurrentStatus === 'pending' || currentStatus === 'active') && newStatus === 'delivered') {
                        showToast('Error updating status: approve order first', 'error');
                        return;
                    }
                    
                    // Handle order approval - move from PendingOrders to AcceptedOrders
                    if ((normalizedCurrentStatus === 'pending' || currentStatus === 'active') && newStatus === 'approved') {
                        await this.moveOrderToAccepted(this.currentEditingOrder, newStatus);
                        return;
                    }
                    
                    // Handle regular status updates within the same collection
                    const response = await fetch(`API_CONFIG.getApiUrl("/orders/${this.currentEditingOrder._id}/status")`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            status: newStatus,
                            updatedBy: 'staff',
                            updatedAt: new Date()
                        })
                    });
                    
                    if (!response.ok) throw new Error('Failed to update order status');
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Update local order
                        this.currentEditingOrder.status = newStatus;
                        
                        showToast(`Order status updated to ${newStatus}`, 'success');
                        
                        // Close modal and refresh
                        document.getElementById('orderModal').classList.remove('show');
                        await this.loadOrders();
                        this.renderOrders();
                    } else {
                        throw new Error(result.message || 'Failed to update order status');
                    }
                    
                } catch (error) {
                    console.error('Error updating order status:', error);
                    showToast('Failed to update order status', 'error');
                }
            }



            // Move order from PendingOrders to AcceptedOrders
            async moveOrderToAccepted(order, newStatus) {
                try {
                    console.log('📋 Moving order to AcceptedOrders collection:', order.orderNumber || order._id);
                    
                    // Prepare order data for AcceptedOrders collection
                    const acceptedOrder = {
                        ...order,
                        status: newStatus,
                        approvedAt: new Date(),
                        approvedBy: Auth.getCurrentUser()?.staffId || 'Unknown Staff'
                    };
                    
                    // Remove the _id field so MongoDB can generate a new one
                    delete acceptedOrder._id;
                    
                    // Step 1: Add to AcceptedOrders collection
                    const addResponse = await fetch('API_CONFIG.getApiUrl("/orders/accepted")', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(acceptedOrder)
                    });
                    
                    if (!addResponse.ok) {
                        throw new Error('Failed to add order to AcceptedOrders collection');
                    }
                    
                    const addResult = await addResponse.json();
                    console.log('✅ Order added to AcceptedOrders:', addResult);
                    
                    // Step 2: Verify the order was added successfully
                    const verifyResponse = await fetch(`API_CONFIG.getApiUrl("/orders/accepted/${addResult.insertedId") || addResult.orderId}`);
                    
                    if (!verifyResponse.ok) {
                        throw new Error('Failed to verify order in AcceptedOrders collection');
                    }
                    
                    console.log('✅ Order verified in AcceptedOrders collection');
                    
                    // Step 3: Remove from PendingOrders collection
                    const deleteResponse = await fetch(`API_CONFIG.getApiUrl("/orders/pending/${order._id}")`, {
                        method: 'DELETE'
                    });
                    
                    if (!deleteResponse.ok) {
                        console.warn('⚠️ Failed to delete from PendingOrders, but order was moved to AcceptedOrders');
                        // Don't fail the entire operation if deletion fails
                    } else {
                        console.log('✅ Order removed from PendingOrders collection');
                    }
                    
                    return true;
                    
                } catch (error) {
                    console.error('❌ Error moving order to AcceptedOrders:', error);
                    return false;
                }
            }
            
            // Add notification for staff when they approve an order
            addStaffNotification(order) {
                const currentUser = Auth.getCurrentUser();
                const staffId = currentUser?.staffId || 'Staff';
                
                const notification = {
                    id: `staff_approved_${order.orderNumber || order._id}_${Date.now()}`,
                    title: '✅ You have approved an order',
                    message: `You have successfully approved order ${order.orderNumber || order._id}. The order has been moved to the accepted queue.`,
                    time: new Date(),
                    read: false,
                    type: 'staff_action',
                    orderNumber: order.orderNumber,
                    staffId: staffId
                };
                
                // Store staff notification in localStorage
                let staffNotifications = JSON.parse(localStorage.getItem('staff_notifications') || '[]');
                staffNotifications.unshift(notification);
                localStorage.setItem('staff_notifications', JSON.stringify(staffNotifications));
                
                // Also add to general notifications for staff dashboard
                let generalNotifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                generalNotifications.unshift(notification);
                localStorage.setItem('notifications', JSON.stringify(generalNotifications));
                
                console.log('📬 Staff approval notification added:', notification);
            }
            
            // Add notification for customer when order status changes
            addCustomerNotification(order) {
                if (!order || !order.userId) return;
                
                // Create notification for the customer
                const notification = {
                    id: `order_approved_${order.orderNumber || order._id}_${Date.now()}`,
                    title: '✅ Order Approved!',
                    message: `Great news! Your order ${order.orderNumber || order._id} has been approved and is now being processed. You will receive another notification when it's ready for delivery.`,
                    time: new Date(),
                    read: false,
                    type: 'order_approved',
                    orderNumber: order.orderNumber || order._id,
                    clickAction: 'view_order',
                    userId: order.userId
                };
                
                // Store notification in localStorage with user-specific key
                const userNotificationKey = `notifications_${order.userId}`;
                let userNotifications = JSON.parse(localStorage.getItem(userNotificationKey) || '[]');
                userNotifications.unshift(notification);
                localStorage.setItem(userNotificationKey, JSON.stringify(userNotifications));
                
                // Also store in general notifications for the system
                let generalNotifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                generalNotifications.unshift(notification);
                localStorage.setItem('notifications', JSON.stringify(generalNotifications));
                
                console.log('📬 Customer approval notification added:', notification);
                
                // Show staff confirmation that customer was notified
                showToast(`Customer notification sent for order ${order.orderNumber || order._id}`, 'info');
                
                // Trigger storage event to update notifications in real-time if customer page is open
                window.dispatchEvent(new StorageEvent('storage', {
                    key: userNotificationKey,
                    newValue: JSON.stringify(userNotifications)
                }));
            }
            
            // Deduct stock when order is approved
            async deductStockForOrder(order) {
                try {
                    console.log('📦 Deducting stock for approved order:', order.orderNumber || order._id);
                    
                    if (!order.itemsordered || !Array.isArray(order.itemsordered)) {
                        console.error('❌ No items found in order for stock deduction');
                        return false;
                    }
                    
                    // Prepare stock updates array from order items
                    const stockUpdates = order.itemsordered.map(item => ({
                        id: item.item_id,
                        quantity: item.amount_per_item
                    })).filter(update => update.id); // Filter out items without IDs
                    
                    if (stockUpdates.length === 0) {
                        console.error('❌ No valid items with IDs found for stock deduction');
                        return false;
                    }
                    
                    console.log('📦 Stock updates to be applied:', stockUpdates);
                    
                    // Send bulk stock update request
                    const response = await fetch('API_CONFIG.getApiUrl("/products/bulk-stock")', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ updates: stockUpdates })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log('✅ Stock deducted successfully for order:', order.orderNumber || order._id);
                        showToast('Order approved and stock updated', 'success');
                        return true;
                    } else {
                        throw new Error(result.message || 'Failed to update stock');
                    }
                    
                } catch (error) {
                    console.error('❌ Error deducting stock for order:', error);
                    showToast('Order approved but stock update failed. Please check inventory manually.', 'warning');
                    return false;
                }
            }

            // Walk-in Order Methods
            saveWalkInOrder() {
                const customerName = document.getElementById('walkInCustomerName').value.trim();
                const customerPhone = document.getElementById('walkInCustomerPhone').value.trim();
                const orderType = document.getElementById('walkInOrderType').value;
                const deliveryAddress = document.getElementById('walkInDeliveryAddress').value.trim();
                const notes = document.getElementById('walkInNotes').value.trim();
                
                if (!customerName) {
                    showToast('Customer name is required', 'error');
                    return;
                }
                
                if (orderType === 'delivery' && !deliveryAddress) {
                    showToast('Delivery address is required', 'error');
                    return;
                }
                
                const walkInOrder = {
                    id: Date.now(),
                    customerName,
                    customerPhone,
                    orderType,
                    deliveryAddress: orderType === 'delivery' ? deliveryAddress : '',
                    notes,
                    items: [],
                    total: 0,
                    paymentMethod: 'cash',
                    date: new Date().toISOString(),
                    status: 'Pending'
                };
                
                this.walkInOrders.unshift(walkInOrder);
                localStorage.setItem('walkInOrders', JSON.stringify(this.walkInOrders));
                
                // Clear form
                document.getElementById('walkInCustomerName').value = '';
                document.getElementById('walkInCustomerPhone').value = '';
                document.getElementById('walkInOrderType').value = 'pickup';
                document.getElementById('walkInDeliveryAddress').value = '';
                document.getElementById('walkInNotes').value = '';
                document.getElementById('deliveryAddressGroup').classList.add('hidden');
                
                document.getElementById('walkInModal').classList.remove('show');
                this.renderWalkInOrders();
                this.updateStats();
                showToast('Walk-in order created successfully', 'success');
            }

            viewWalkInOrder(orderId) {
                const order = this.walkInOrders.find(o => o.id == orderId);
                if (!order) return;
                
                const details = document.getElementById('orderDetails');
                details.innerHTML = `
                    <div class="order-info">
                        <div class="order-header">
                            <h3>Walk-in Order #${order.id.toString().slice(-6)}</h3>
                            <span class="status-badge completed">Walk-in</span>
                        </div>
                        <div class="order-customer-info">
                            <p><strong>Customer:</strong> ${order.customerName}</p>
                            <p><strong>Phone:</strong> ${order.customerPhone || 'Not provided'}</p>
                            <p><strong>Date:</strong> ${new Date(order.date).toLocaleString()}</p>
                            <p><strong>Order Type:</strong> ${order.orderType}</p>
                            ${order.deliveryAddress ? `<p><strong>Delivery Address:</strong> ${order.deliveryAddress}</p>` : ''}
                            <p><strong>Payment Method:</strong> ${this.formatPaymentMethod(order.paymentMethod)}</p>
                            <p><strong>Total:</strong> ₱${order.total.toFixed(2)}</p>
                            ${order.notes ? `<p><strong>Notes:</strong> ${order.notes}</p>` : ''}
                        </div>
                    </div>
                    <div class="order-items">
                        <h4>Items Ordered:</h4>
                        <div class="order-items-list">
                            ${order.items.map(item => `
                                <div class="order-item">
                                    <span class="item-name">${item.name}</span>
                                    <span class="item-quantity">×${item.quantity}</span>
                                    <span class="item-price">₱${item.price.toFixed(2)}</span>
                                    <span class="item-total">₱${(item.price * item.quantity).toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                document.getElementById('orderModal').classList.add('show');
            }

            // File handling methods
            handleFileSelect(file) {
                if (file.size > 5 * 1024 * 1024) {
                    showToast('File size must be less than 5MB', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewImg = document.getElementById('previewImg');
                    const imagePreview = document.getElementById('imagePreview');
                    const removeBtn = document.getElementById('removeImageBtn');
                    
                    previewImg.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                    removeBtn.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }

            removeImage() {
                const previewImg = document.getElementById('previewImg');
                const imagePreview = document.getElementById('imagePreview');
                const fileInput = document.getElementById('fileInput');
                const removeBtn = document.getElementById('removeImageBtn');
                
                previewImg.src = '';
                imagePreview.classList.add('hidden');
                fileInput.value = '';
                removeBtn.classList.add('hidden');
            }

            handleLogout() {
                const currentUser = Auth.getCurrentUser();
                const staffId = currentUser ? currentUser.staffId : '';
                const result = Auth.logout();
                if (result.success) {
                    showToast(`${staffId} successfully logged out`);
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                } else {
                    showToast(result.message);
                }
            }

            clearWalkInOrders() {
                this.walkInOrders = [];
                localStorage.setItem('walkInOrders', JSON.stringify(this.walkInOrders));
                this.renderWalkInOrders();
                this.updateStats();
                showToast('Walk-in orders cleared', 'success');
            }

            // Modern modal helper methods
            showProofPreview(base64Data) {
                if (!base64Data) {
                    showToast('No proof of payment available', 'error');
                    return;
                }
                
                // Create modal for proof preview
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    cursor: pointer;
                `;
                
                const img = document.createElement('img');
                img.src = base64Data;
                img.style.cssText = `
                    max-width: 90%;
                    max-height: 90%;
                    object-fit: contain;
                    border-radius: 8px;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                `;
                
                // Add close button
                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '×';
                closeBtn.style.cssText = `
                    position: absolute;
                    top: 20px;
                    right: 30px;
                    background: rgba(255,255,255,0.9);
                    border: none;
                    border-radius: 50%;
                    width: 40px;
                    height: 40px;
                    font-size: 24px;
                    font-weight: bold;
                    cursor: pointer;
                    color: #333;
                    z-index: 10001;
                `;
                
                modal.appendChild(img);
                modal.appendChild(closeBtn);
                document.body.appendChild(modal);
                
                // Close modal on click
                modal.onclick = (e) => {
                    if (e.target === modal || e.target === closeBtn) {
                        document.body.removeChild(modal);
                    }
                };
                
                // Close on escape key
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        document.body.removeChild(modal);
                        document.removeEventListener('keydown', handleEscape);
                    }
                };
                document.addEventListener('keydown', handleEscape);
            }

            // Generate order number for orders that don't have one
            generateOrderNumber(order) {
                // Use the creation date or fallback to current time
                const timestamp = order.createdAt || order.orderDate || order.original_date || new Date();
                const date = new Date(timestamp);
                const timeNum = date.getTime();
                
                // Use the last 6 characters of MongoDB ObjectId as a unique identifier
                const uniqueId = order._id ? order._id.slice(-6) : Math.floor(Math.random() * 1000);
                
                return `ORD-${timeNum}-${uniqueId}`;
            }
        }

        // Loading animation functions (simplified - no setTimeout delays)
        function showLoadingStats() {
            const statNumbers = [
                'totalProducts',
                'pendingOrders', 
                'completedOrders',
                'deliveredProducts',
                'walkInOrders',
                'totalRevenue'
            ];
            
            statNumbers.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = '<span class="loadingBob">...</span>';
                }
            });
        }

        function showLoadingProducts() {
            const productsTableBody = document.getElementById('productsTableBody');
            if (productsTableBody) {
                productsTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="loading-spinner">
                            <div class="spinner"></div>
                            <div class="loading-text">Loading products...</div>
                        </td>
                    </tr>
                `;
            }
        }

        function showLoadingOrders() {
            const ordersTableBody = document.getElementById('ordersTableBody');
            if (ordersTableBody) {
                ordersTableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="loading-spinner">
                            <div class="spinner"></div>
                            <div class="loading-text">Loading orders...</div>
                        </td>
                    </tr>
                `;
            }
        }

        function showLoadingWalkInOrders() {
            const walkInOrdersTableBody = document.getElementById('walkInOrdersTableBody');
            if (walkInOrdersTableBody) {
                walkInOrdersTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="loading-spinner">
                            <div class="spinner"></div>
                            <div class="loading-text">Loading walk-in orders...</div>
                        </td>
                    </tr>
                `;
            }
            
            // Also show loading in walk-in stats
            const statValues = ['todayWalkIns', 'weekWalkIns', 'monthWalkIns'];
            statValues.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = '<span class="loadingBob">...</span>';
                }
            });
        }

        // Initialize Enhanced Staff Dashboard
        const staffDashboard = new EnhancedStaffDashboard();

        // Close notification dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationDropdown = document.getElementById('notificationDropdown');
            
            if (!notificationBtn.contains(e.target) && !notificationDropdown.contains(e.target)) {
                notificationDropdown.classList.remove('show');
            }
        });

        // Global helper functions for the modern modal
        function copyStaffOrderId() {
            const orderIdElement = document.getElementById('staffModalOrderId');
            const orderText = orderIdElement.textContent;
            
            // Use the Clipboard API if available
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(orderText).then(() => {
                    showToast('Order ID copied to clipboard!', 'success');
                }).catch(() => {
                    fallbackCopyTextToClipboard(orderText);
                });
            } else {
                fallbackCopyTextToClipboard(orderText);
            }
        }

        // Fallback copy function
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showToast('Order ID copied to clipboard!', 'success');
            } catch (err) {
                showToast('Failed to copy order ID', 'error');
            }
            
            document.body.removeChild(textArea);
        }

        // Loading animation functions (simplified - no setTimeout delays)
        function showLoadingStats() {
            const statNumbers = [
                'totalProducts',
                'pendingOrders', 
                'completedOrders',
                'deliveredProducts',
                'walkInOrders',
                'totalRevenue'
            ];
            
            statNumbers.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = '<span class="loadingBob">...</span>';
                }
            });
        }

        function showLoadingProducts() {
            const productsTableBody = document.getElementById('productsTableBody');
            if (productsTableBody) {
                productsTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="loading-spinner">
                            <div class="spinner"></div>
                            <div class="loading-text">Loading products...</div>
                        </td>
                    </tr>
                `;
            }
        }

        function showLoadingOrders() {
            const ordersTableBody = document.getElementById('ordersTableBody');
            if (ordersTableBody) {
                ordersTableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="loading-spinner">
                            <div class="spinner"></div>
                            <div class="loading-text">Loading orders...</div>
                        </td>
                    </tr>
                `;
            }
        }

        function showLoadingWalkInOrders() {
            const walkInOrdersTableBody = document.getElementById('walkInOrdersTableBody');
            if (walkInOrdersTableBody) {
                walkInOrdersTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="loading-spinner">
                            <div class="spinner"></div>
                            <div class="loading-text">Loading walk-in orders...</div>
                        </td>
                    </tr>
                `;
            }
            
            // Also show loading in walk-in stats
            const statValues = ['todayWalkIns', 'weekWalkIns', 'monthWalkIns'];
            statValues.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = '<span class="loadingBob">...</span>';
                }
            });
        }

        // Initialize Enhanced Staff Dashboard
        const staffDashboard = new EnhancedStaffDashboard();
    </script>
</body>
</html>